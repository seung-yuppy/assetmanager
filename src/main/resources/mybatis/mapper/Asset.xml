<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.example.assetmanager.dao.AssetDAO">

	<select id="countAll" resultType="int">
		SELECT COUNT(*)
		FROM Asset
		WHERE is_valid = 1
	</select>
	
	<select id="listAll" resultType="AssetDTO">
		SELECT *
		FROM (
			SELECT ROWNUM AS rnum, a.*
			FROM (
				SELECT *
				FROM Asset
				INNER JOIN Category ON Asset.category_id = Category.id
				WHERE is_valid = 1
			) a
		)
		WHERE rnum BETWEEN #{start} AND #{end}
	</select>
	
	<select id="countDisposal">
		SELECT COUNT(*)
		FROM Asset_Disposal
	</select>
	
	<select id="listDisposal">
		SELECT *
		FROM (
			SELECT ROWNUM AS rnum, a.*
			FROM (
				SELECT *
				FROM Asset_Disposal
					INNER JOIN Asset ON Asset_Disposal.asset_id = Asset.id
					INNER JOIN "User" ON Asset_Disposal.approver_id = "User".id
					INNER JOIN Category ON Asset.category_id = Category.id
			) a
		)
		WHERE rnum BETWEEN #{start} AND #{end}
	</select>
	
	<select id="assetDetail" resultType="AssetDTO">
		SELECT *
		FROM Asset
			INNER JOIN Category ON Asset.category_id = Category.id
		WHERE Asset.id = #{id}
	</select>
	
	<update id="modifyAsset">
		UPDATE Asset
		SET
			asset_name = #{asset.assetName},
			serial_number = #{asset.serialNumber},
			spec = #{asset.spec}
		WHERE
			id = #{asset.id}
	</update>
	
	<update id="deleteAsset">
		UPDATE Asset
		SET
			is_valid = 0
		WHERE
			id = #{asset.assetId}
	</update>
	
	<insert id="deleteAssetDisposal">
		INSERT INTO Asset_Disposal
			(asset_id, approver_id, disposal_date, disposal_reason)
		VALUES (
			#{asset.assetId},
			#{asset.approverId},
			SYSDATE,
			#{asset.disposalReason}
		)
	</insert>
	
	<select id="countMyAsset">
		SELECT COUNT(*)
		FROM Asset a
			INNER JOIN Category c ON c.id = a.category_id
			INNER JOIN Asset_History ah ON ah.asset_id = a.id
			LEFT OUTER JOIN Rent_Content rc ON rc.asset_id = a.id
			LEFT OUTER JOIN RENT r ON r.id = rc.rent_id
		WHERE a.is_valid = 1 AND a.user_id = #{userId}
	</select>
	
	<select id="listHistory">
		SELECT *
		FROM (
			SELECT ROWNUM AS rnum, k.*
			FROM (
				SELECT a.asset_name, a.serial_number, c.category_name, ah.create_date, r.return_date
				FROM Asset a
					INNER JOIN Category c ON c.id = a.category_id
					INNER JOIN Asset_History ah ON ah.asset_id = a.id
					LEFT OUTER JOIN Rent_Content rc ON rc.asset_id = a.id
					LEFT OUTER JOIN RENT r ON r.id = rc.rent_id
				WHERE a.is_valid = 1 AND a.user_id = #{userId}
			) k
		)
		WHERE rnum BETWEEN #{start} AND #{end}
	</select>

</mapper>