<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.example.assetmanager.dao.HomeDAO">
	<select id="countDept">
		WITH DepartmentAsset AS (
		    SELECT id
		    FROM "User"
		    WHERE 
		        department_id = (SELECT department_id FROM "User" WHERE id = #{userId})
		        AND role = 'department'
		),
		FindLastStatus AS (
		    SELECT
		        asset_id,
		        user_id,
		        create_date,
		        status,
		        ROW_NUMBER() OVER(PARTITION BY asset_id, user_id ORDER BY create_date DESC, id DESC) as rn
		    FROM
		        Asset_History
		    WHERE
		        user_id IN (SELECT id FROM DepartmentAsset)
		),
		InUseAssets AS (
		    SELECT
		        asset_id,
		        create_date AS acquisition_date
		    FROM
		        FindLastStatus
		    WHERE
		        rn = 1
		        AND status = 'rent'
		),
		CurrentRent AS (
		    SELECT
		        rc.asset_id,
		        r.return_date,
		        ROW_NUMBER() OVER(PARTITION BY rc.asset_id ORDER BY r.rent_date DESC, r.id DESC) as rn
		    FROM
		        Rent_Content rc
		    JOIN
		        Rent r ON rc.rent_id = r.id
		)
		SELECT
			COUNT(a.id)
		FROM
		    Asset a
		INNER JOIN
		    Category c ON a.category_id = c.id
		INNER JOIN
		    InUseAssets iua ON a.id = iua.asset_id
		LEFT JOIN
		    CurrentRent cr ON iua.asset_id = cr.asset_id AND cr.rn = 1
		WHERE
		    a.user_id IN (SELECT id FROM DepartmentAsset)		 	
	</select>
	
	<select id="countOrderFirstA">
	    SELECT COUNT(o.id)
		FROM Orders o
			JOIN Approval a ON o.approval_id = a.id
		WHERE a.status = 'FIRST_APPROVAL'
		AND a.manager_id = #{userId}
		AND o.is_valid = 1		
	</select>
	
	<select id="countOrderFinalA">
	    SELECT COUNT(o.id)
		FROM Orders o
			JOIN Approval a ON o.approval_id = a.id
		WHERE a.status = 'FINAL_APPROVAL'
		AND a.manager_id = #{userId}
		AND o.is_valid = 1		
	</select>
	
	<select id="countRentFirstA">
		SELECT COUNT(r.id)
		FROM Rent r
			JOIN Approval a ON r.approval_id = a.id
		WHERE a.status = 'FIRST_APPROVAL'
		AND a.manager_id = #{userId}
		AND r.is_valid = 1	
	</select>
	
	<select id="countRentFinalA">
		SELECT COUNT(r.id)
		FROM Rent r
			JOIN Approval a ON r.approval_id = a.id
		WHERE a.status = 'FINAL_APPROVAL'
		AND a.manager_id = #{userId}
		AND r.is_valid = 1	
	</select>
	
	<select id="listDeptTop3">
		WITH DepartmentAsset AS (
		    SELECT id
		    FROM "User"
		    WHERE 
		        department_id = (SELECT department_id FROM "User" WHERE id = #{userId})
		        AND role = 'department'
		),
		FindLastStatus AS (
		    SELECT
		        asset_id,
		        user_id,
		        create_date,
		        status,
		        ROW_NUMBER() OVER(PARTITION BY asset_id, user_id ORDER BY create_date DESC, id DESC) as rn
		    FROM
		        Asset_History
		    WHERE
		        user_id IN (SELECT id FROM DepartmentAsset)
		),
		InUseAssets AS (
		    SELECT
		        asset_id,
		        create_date AS acquisition_date
		    FROM
		        FindLastStatus
		    WHERE
		        rn = 1
		        AND status = 'rent'
		),
		CurrentRent AS (
		    SELECT
		        rc.asset_id,
		        r.return_date,
		        ROW_NUMBER() OVER(PARTITION BY rc.asset_id ORDER BY r.rent_date DESC, r.id DESC) as rn
		    FROM
		        Rent_Content rc
		    JOIN
		        Rent r ON rc.rent_id = r.id
		)
		SELECT
		    a.id AS asset_id,
		    a.asset_name,
		    c.category_name,
		    a.serial_number,
		    iua.acquisition_date AS create_date, 
		    cr.return_date
		FROM
		    Asset a
		INNER JOIN
		    Category c ON a.category_id = c.id
		INNER JOIN
		    InUseAssets iua ON a.id = iua.asset_id
		INNER JOIN
		    CurrentRent cr ON iua.asset_id = cr.asset_id AND cr.rn = 1
		WHERE
		    a.user_id IN (SELECT id FROM DepartmentAsset)
        ORDER BY
            iua.acquisition_date DESC
            FETCH FIRST 3 ROWS ONLY	
	</select>
	
	<select id="listOrderFirstATop3">
	    SELECT *
		FROM Orders o
			INNER JOIN Approval a ON o.approval_id = a.id
		WHERE a.manager_id = #{userId}
		AND a.status = 'FIRST_APPROVAL'
		ORDER BY o.order_date DESC
		FETCH FIRST 3 ROWS ONLY	
	</select>
	
	<select id="listRentFirstATop3">
		SELECT *
		FROM Rent r
			INNER JOIN Approval a ON r.approval_id = a.id
		WHERE a.manager_id = #{userId}
		AND a.status = 'FIRST_APPROVAL'
		ORDER BY r.rent_date DESC
		FETCH FIRST 3 ROWS ONLY	
	</select>
	
	<select id="countUsing">
		WITH FindLastStatus AS (
            SELECT
                asset_id,
                user_id,
                create_date,
                status,
                ROW_NUMBER() OVER(PARTITION BY asset_id ORDER BY create_date DESC, id DESC) as rn
            FROM
                Asset_History
            WHERE
                user_id = #{userId}
        ),
        InUseAssets AS (
            SELECT
                asset_id,
                create_date AS acquisition_date
            FROM
                FindLastStatus
            WHERE
                rn = 1
                AND status = 'rent'
        ),
        CurrentRent AS (
            SELECT
                rc.asset_id,
                r.return_date,
                ROW_NUMBER() OVER(PARTITION BY rc.asset_id ORDER BY r.rent_date DESC, r.id DESC) as rn
            FROM
                Rent_Content rc
            JOIN
                Rent r ON rc.rent_id = r.id
        )
        SELECT
			COUNT(*)
        FROM
            Asset a
        JOIN
        	Category c ON c.id = a.category_id
        JOIN
            InUseAssets iua ON a.id = iua.asset_id
        LEFT JOIN
            CurrentRent cr ON iua.asset_id = cr.asset_id AND cr.rn = 1
        WHERE
            a.user_id = #{userId}
	</select>
	
	<select id="listUsingTop3">
      	WITH FindLastStatus AS (
		    SELECT
		        asset_id,
		        user_id,
		        create_date,
		        status, 
		        ROW_NUMBER() OVER(PARTITION BY asset_id, user_id ORDER BY create_date DESC, id DESC) as rn
		    FROM
		        Asset_History
		    WHERE
		        user_id = #{userId}
		),
		InUseAssets AS (
		    SELECT
		        asset_id,
		        create_date AS acquisition_date
		    FROM
		        FindLastStatus
		    WHERE
		        rn = 1
		        AND status = 'rent'
		),
		CurrentRent AS (
		    SELECT
		        rc.asset_id,
		        r.return_date,
		        ROW_NUMBER() OVER(PARTITION BY rc.asset_id ORDER BY r.rent_date DESC, r.id DESC) as rn
		    FROM
		        Rent_Content rc
		    JOIN
		        Rent r ON rc.rent_id = r.id
		)
		SELECT
		    a.id AS asset_id,
		    a.asset_name,
		    c.category_name,
		    a.serial_number,
		    iua.acquisition_date AS create_date, 
		    cr.return_date
		FROM
		    Asset a
		INNER JOIN
		    Category c ON a.category_id = c.id
		INNER JOIN
		    InUseAssets iua ON a.id = iua.asset_id
		INNER JOIN
		    CurrentRent cr ON iua.asset_id = cr.asset_id AND cr.rn = 1
		WHERE
		    a.user_id = #{userId}
        ORDER BY
            iua.acquisition_date DESC
            FETCH FIRST 3 ROWS ONLY	
	</select>
	
	<select id="countItem">
		SELECT COUNT(*)
		FROM Standard_Item
	</select>
	
	<select id="listDeptCount">
		SELECT d.dept_name, COUNT(a.id) AS dept_count
		FROM Department d
		LEFT JOIN "User" u ON d.id = u.department_id
		LEFT JOIN Asset a ON u.id = a.user_id
		GROUP BY d.dept_name
		HAVING d.dept_name NOT IN ('경영지원팀')
		ORDER BY d.dept_name
	</select>
	
	<select id="listCategoryCount">
		SELECT c.category_name, COUNT(*) AS category_count
		FROM Asset a
		INNER JOIN Category c ON a.category_id = c.id
		GROUP BY c.category_name
	</select>
	
	<select id="countOrder">
		SELECT COUNT(*)
		FROM Orders o
		INNER JOIN Approval a ON o.approval_id = a.id
		WHERE a.approver_id = #{userId} AND a.status = 'pending'
	</select>
	
	<select id="countRent">	
		SELECT COUNT(*)
		FROM Rent r
		INNER JOIN Approval a ON r.approval_id = a.id
		WHERE a.approver_id = #{userId} AND a.status = 'pending'	
	</select>
	
	<select id="countReturn">
		SELECT COUNT(*)
		FROM Asset_Return
		WHERE is_return = 0		
	</select>
</mapper>