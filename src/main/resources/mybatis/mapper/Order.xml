<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.example.assetmanager.dao.OrderDAO">
	<select id="listAll" parameterType="OrderParamDTO" resultType="OrderDto">
		SELECT 
			DISTINCT o.id,
		    o.title,
		    o.user_id,
		    o.order_date,
		    o.request_msg,
		    a.status,
		    (
		        SELECT
		            SUM(price)
		        FROM
		            order_content
		        WHERE
		            order_id = o.id
		    ) total_price
		FROM
		    orders o
			    left JOIN order_content oc ON o.id = oc.order_id
			    left JOIN approval      a ON o.approval_id = a.id
	    <where>
		    o.user_id = #{userId}
	       	<if test="keyword != null and keyword != ''">
	    		and (o.title like '%' || #{keyword} || '%'
	    			or o.request_msg like '%' || #{keyword} || '%')
	    	</if>
	       	<if test="status != null and status != ''">
	    		and (upper(a.status) like upper('%' || #{status} || '%'))
	    	</if>
	    </where>
    	order by o.order_date desc
	    offset #{offset} rows
    	fetch next #{size} rows only
	</select>
	<select id="countAll" parameterType="OrderParamDTO" resultType="int">
		select count(distinct o.id) 
		from orders o
		left join order_content oc on o.id = oc.order_id
		left JOIN approval      a ON o.approval_id = a.id
	    <where>
		    o.user_id = #{userId}
	       	<if test="keyword != null and keyword != ''">
	    		and (o.title like '%' || #{keyword} || '%'
	    			or o.request_msg like '%' || #{keyword} || '%')
	    	</if>
	       	<if test="status != null and status != ''">
	    		and (a.status like '%' || #{status} || '%')
	    	</if>
	    </where>
	</select>
    
	<insert id="insertOrder" parameterType="OrderFormDTO" useGeneratedKeys="true" keyProperty="id" keyColumn="id">
	    INSERT INTO orders (user_id, approval_id, request_msg, title)
	    VALUES (#{userId}, #{approvalId}, #{requestMsg}, #{title})
	</insert>

    <insert id="insertOrderContent" parameterType="OrderContentDTO">
        INSERT INTO Order_Content (order_id, category_id, item_name, price , count)
        VALUES (#{orderId}, #{categoryId}, #{itemName}, #{price}, #{count})
    </insert>
    
    <select id="getOrderById" parameterType="int">
    	select * 
    	from orders 
    	where id = ${id}
    </select>
    
    <select id="getContentsByOrderId" parameterType="int" resultType="OrderContentDTO">
    	select o.*, c.category_name
    	from order_content o
    		join category c on o.category_id = c.id
    	where order_id = #{id}
    </select>
</mapper>