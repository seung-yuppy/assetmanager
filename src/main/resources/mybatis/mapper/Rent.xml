<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.example.assetmanager.dao.RentDAO">
	<select id="findByAdminUser" resultType="UserInfoDTO">
		SELECT U.id
			   ,U.username
			   ,U.profile_image
			   ,D.dept_name
			   ,U.role
			   ,U.position
		FROM "User" U 
		JOIN Department D ON U.department_id = D.id
		WHERE D.dept_name = '경영지원팀' 
		AND U.role = 'admin'
	</select>
	
	<select id="findByManagerUser" resultType="UserInfoDTO">
		SELECT U.id
			   ,U.username
			   ,U.profile_image
			   ,D.dept_name
			   ,U.role
			   ,U.position
		FROM "User" U
		JOIN Department D ON U.department_id = D.id
		WHERE U.role = 'manager'
	</select>
	
	<select id="findByAsset" parameterType="int" resultType="AssetDTO">
		SELECT asset_name, spec, count(*) AS count
		FROM Asset		
		<where>
        <if test="categoryId != 0">
            AND category_id = #{categoryId}
        </if>
        	AND is_valid = 1
        	AND user_id IS NULL
        	AND is_request = 0
        </where>
        GROUP BY asset_name, spec
	</select>
		
	<insert id="insertRent" parameterType="RentDTO" useGeneratedKeys="true" keyProperty="rentDTO.id" keyColumn="id">
		INSERT INTO Rent (approval_id, user_id, title, return_date, request_msg, is_delay) 
		VALUES (#{rentDTO.approvalId}, #{userId}, #{rentDTO.title}, TO_TIMESTAMP(#{rentDTO.returnDate}, 'YYYY-MM-DD'), #{rentDTO.requestMsg}, #{rentDTO.isDelay})
	</insert>
	
	<insert id="insertRentContent" parameterType="RentContentDTO">
		INSERT INTO RENT_CONTENT (rent_id,asset_id)
		VALUES (#{rentContentDTO.rentId}, #{rentContentDTO.assetId})
	</insert>
	
	<select id="selectCount">
		SELECT id AS asset_id
		FROM Asset
		WHERE asset_name = #{assetName} 
			AND user_id IS NULL
			AND is_valid = 1
		FETCH FIRST #{count} ROWS ONLY			
	</select>
	
	<select id="findRentList" parameterType="RentParamDTO" resultType="RentListDTO">
	    SELECT
	        R.id,
	        R.title,
	        R.rent_date AS rentDate,
	        R.return_date AS returnDate,
	        A.status status,
	        R.is_valid
	    FROM 
	        Rent R
	    JOIN
	    	Approval A ON R.approval_id = A.id
	    <where>
	    	R.user_id = #{userId}
	       	<if test="keyword != null and keyword != ''">
	    		AND (R.title like '%' || #{keyword} || '%')
	    	</if>
	       	<if test="status != null and status != ''">
	    		AND (upper(A.status) like upper('%' || #{status} || '%'))
	    	</if>
	    </where>
	    ORDER BY 
	        R.rent_date DESC
	        offset #{offset} rows
    		fetch next #{size} rows only
	</select>
	
	<select id="findAdminList" parameterType="RentParamDTO" resultType="RentListDTO">
	    SELECT R.id
	         , R.title
	         , R.rent_date rentDate
	         , A.status status
	         , U.username username
	         , D.dept_name deptName
	         , R.user_id
	    FROM Rent R
	    JOIN Approval A ON A.id = R.approval_id
	    LEFT JOIN "User" U ON U.id = R.user_id
	    LEFT JOIN Department D ON D.id = U.department_id
	    <where>
	    	A.approver_id = #{userId} 
	    		AND R.is_valid = 1
	    		AND R.is_delay = 0
	       	<if test="keyword != null and keyword != ''">
	    		AND (U.username like '%' || #{keyword} || '%')
	    	</if>
	       	<if test="status != null and status != ''">
	    		AND (upper(A.status) like upper('%' || #{status} || '%'))
	    	</if>
	    </where>
    	ORDER BY R.rent_date DESC
	    offset #{offset} rows
    	fetch next #{size} rows only    
	</select>
	
	<select id="findAdminDelayList" parameterType="RentParamDTO" resultType="RentListDTO">
	    SELECT R.id
	         , R.title
	         , R.rent_date rentDate
	         , A.status status
	         , U.username username
	         , D.dept_name deptName
	         , R.user_id
	    FROM Rent R
	    JOIN Approval A ON A.id = R.approval_id
	    LEFT JOIN "User" U ON U.id = R.user_id
	    LEFT JOIN Department D ON D.id = U.department_id
	    <where>
	    	A.approver_id = #{userId} 
	    		AND R.is_valid = 1
	    		AND R.is_delay = 1
	       	<if test="keyword != null and keyword != ''">
	    		AND (U.username like '%' || #{keyword} || '%')
	    	</if>
	       	<if test="status != null and status != ''">
	    		AND (upper(A.status) like upper('%' || #{status} || '%'))
	    	</if>
	    </where>
    	ORDER BY R.rent_date DESC
	    offset #{offset} rows
    	fetch next #{size} rows only    
	</select>
	
	<select id="findManagerList" parameterType="RentParamDTO" resultType="RentListDTO">
	    SELECT R.id
	         , R.title
	         , R.rent_date rentDate
	         , A.status status
	         , U.username username
	         , D.dept_name deptName
	         , R.user_id
	    FROM Rent R
	    JOIN Approval A ON A.id = R.approval_id
	    LEFT JOIN "User" U ON U.id = R.user_id
	    LEFT JOIN Department D ON D.id = U.department_id
	    <where>
	    	A.manager_id = #{userId} 
	    		AND R.is_valid = 1
	    		AND R.is_delay = 0
	    		AND A.status NOT IN ('pending')
	       	<if test="keyword != null and keyword != ''">
	    		AND (U.username like '%' || #{keyword} || '%')
	    	</if>
	       	<if test="status != null and status != ''">
	    		AND (upper(A.status) like upper('%' || #{status} || '%'))
	    	</if>
	    </where>
    	ORDER BY R.rent_date DESC
	    offset #{offset} rows
    	fetch next #{size} rows only    
	</select>
	
	<select id="findManagerDelayList" parameterType="RentParamDTO" resultType="RentListDTO">
	    SELECT R.id
	         , R.title
	         , R.rent_date rentDate
	         , A.status status
	         , U.username username
	         , D.dept_name deptName
	         , R.user_id
	    FROM Rent R
	    JOIN Approval A ON A.id = R.approval_id
	    LEFT JOIN "User" U ON U.id = R.user_id
	    LEFT JOIN Department D ON D.id = U.department_id
	    <where>
	    	A.manager_id = #{userId} 
	    		AND R.is_valid = 1
	    		AND R.is_delay = 1
	    		AND A.status NOT IN ('pending')
	       	<if test="keyword != null and keyword != ''">
	    		AND (U.username like '%' || #{keyword} || '%')
	    	</if>
	       	<if test="status != null and status != ''">
	    		AND (upper(A.status) like upper('%' || #{status} || '%'))
	    	</if>
	    </where>
    	ORDER BY R.rent_date DESC
	    offset #{offset} rows
    	fetch next #{size} rows only    
	</select>
	
	<select id="countAll" parameterType="RentParamDTO" resultType="int">
		SELECT count(*) 
		FROM Rent R
		left JOIN approval A ON R.approval_id = A.id
	    <where>
		    R.user_id = #{userId} 
		    	AND R.is_valid = 1
	       	<if test="keyword != null and keyword != ''">
	    		AND (R.title LIKE '%' || #{keyword} || '%')
	    	</if>
	       	<if test="status != null and status != ''">
	    		AND (upper(A.status) LIKE upper('%' || #{status} || '%'))
	    	</if>
	    </where>
	</select>
	
	<select id="countAllForAdmin" parameterType="RentParamDTO" resultType="int">
		SELECT count(*) 
		FROM Rent R
		LEFT JOIN Approval A ON R.approval_id = A.id
		JOIN "User" U ON R.user_id = U.id
	    <where>
		    A.approver_id = #{userId} 
		    	AND R.is_valid = 1
		    	AND R.is_delay = 0
	       	<if test="keyword != null and keyword != ''">
	    		AND (U.username like '%' || #{keyword} || '%')
	    	</if>
	       	<if test="status != null and status != ''">
	    		AND (upper(A.status) LIKE upper('%' || #{status} || '%'))
	    	</if>
	    </where>
	</select>
	
	<select id="countAllForAdminDelay" parameterType="RentParamDTO" resultType="int">
		SELECT count(*) 
		FROM Rent R
		LEFT JOIN Approval A ON R.approval_id = A.id
		JOIN "User" U ON R.user_id = U.id
	    <where>
		    A.approver_id = #{userId} 
		    	AND R.is_valid = 1
		    	AND R.is_delay = 1
	       	<if test="keyword != null and keyword != ''">
	    		AND (U.username like '%' || #{keyword} || '%')
	    	</if>
	       	<if test="status != null and status != ''">
	    		AND (upper(A.status) LIKE upper('%' || #{status} || '%'))
	    	</if>
	    </where>
	</select>
	
	<select id="countAllForManager" parameterType="RentParamDTO" resultType="int">
		SELECT count(*) 
		FROM Rent R
		LEFT JOIN Approval A ON R.approval_id = A.id
		JOIN "User" U ON R.user_id = U.id
	    <where>
		    A.manager_id = #{userId} 
		    	AND R.is_valid = 1
		    	AND R.is_delay = 0
	       	<if test="keyword != null and keyword != ''">
	    		AND (U.username like '%' || #{keyword} || '%')
	    	</if>
	       	<if test="status != null and status != ''">
	    		AND (upper(A.status) LIKE upper('%' || #{status} || '%'))
	    	</if>
	    </where>
	</select>
	
	<select id="countAllForManagerDelay" parameterType="RentParamDTO" resultType="int">
		SELECT count(*) 
		FROM Rent R
		LEFT JOIN Approval A ON R.approval_id = A.id
		JOIN "User" U ON R.user_id = U.id
	    <where>
		    A.manager_id = #{userId} 
		    	AND R.is_valid = 1
		    	AND R.is_delay = 1
	       	<if test="keyword != null and keyword != ''">
	    		AND (U.username like '%' || #{keyword} || '%')
	    	</if>
	       	<if test="status != null and status != ''">
	    		AND (upper(A.status) LIKE upper('%' || #{status} || '%'))
	    	</if>
	    </where>
	</select>

	<select id="getRentApprovalId" resultType="RentDTO">
		SELECT id
			   ,approval_id 
			   ,user_id
		FROM Rent R 
		WHERE R.id = #{id}
	</select>
	
	<select id="getRent">
		SELECT request_msg
			  ,return_date
			  ,rent_date
			  ,is_delay
		FROM Rent R
		WHERE R.id = #{id}
	</select>
	
	<select id="getRentContent" >
		SELECT rent_id
			  ,user_id
			  ,asset_id
			  ,asset_name
			  ,category_name
			  ,spec
		FROM RENT_CONTENT RC
		JOIN Asset A ON RC.asset_id = A.id
		JOIN Category C ON C.id = A.category_id
		WHERE RC.rent_id = #{rentId}
	</select>

	<select id="getDeptAddressByUserId" resultType="String">
        SELECT D.dept_address
        FROM "User" U
        JOIN Department D ON U.department_id = D.id
        WHERE U.id = #{userId}
    </select>
    
    <update id="cancelRent">
    	update Rent
    	set is_valid = 0
    	where id = #{id} 
    </update>
    
    <select id="getRentIdWithUserId">
    	SELECT *
    	FROM Rent 
    	WHERE user_id = #{userId} AND id = #{id}
    </select>
    
    <select id="getPendingRent">
		SELECT COUNT(r.id)
		FROM Rent r
			JOIN Approval a ON r.approval_id = a.id
		WHERE a.status = 'pending'
		AND r.user_id = #{userId}
		AND r.is_valid = 1
	</select>
	
	<select id="getApprovalRent">
		SELECT COUNT(r.id)
		FROM Rent r
			JOIN Approval a ON r.approval_id = a.id
		WHERE a.status = 'FINAL_APPROVAL'
		AND r.user_id = #{userId}
		AND r.is_valid = 1
	</select>
	
	<insert id="insertAssetReturn" parameterType="AssetReturnDTO" useGeneratedKeys="true" keyProperty="id"  keyColumn="id">
		INSERT INTO Asset_Return (user_id, asset_id,is_return)
		VALUES (#{userId}, #{assetId}, 0)
	</insert>
	
	<select id="findAssetReturn">
		SELECT AR.*
		      ,U.username
		      ,D.dept_name
		      ,A.*
		FROM Asset_Return AR
		JOIN "User" U ON U.id = AR.user_id
		JOIN Department D ON D.id = U.department_id
		JOIN Asset A ON A.id = AR.asset_id
		<where>
	        <if test="keyword != null and keyword != ''">
	    		AND (U.username like '%' || #{keyword} || '%')
	    	</if>
	        <if test="status == 'pending'">
	    		AND is_Return = 0
	    	</if>
	    	<if test="status == 'FINAL_APPROVAL'">
	    		AND is_Return = 1
	    	</if>	        
	    </where>
	    ORDER BY AR.return_date DESC  
	    OFFSET #{offset} ROWS
	    FETCH NEXT #{size} ROWS ONLY
	</select>
	
	<select id="countAssetReturn" parameterType="RentParamDTO" resultType="int">
	    SELECT COUNT(*)
	    FROM Asset_Return AR
	    JOIN "User" U ON U.id = AR.user_id
	    JOIN Department D ON D.id = U.department_id
	    JOIN Asset A ON A.id = AR.asset_id
	    <where>
	        <if test="keyword != null and keyword != ''">
	    		AND (U.username like '%' || #{keyword} || '%')
	    	</if>
	        <if test="status == 'pending'">
	    		AND is_Return = 0
	    	</if>
	    	<if test="status == 'FINAL_APPROVAL'">
	    		AND is_Return = 1
	    	</if>
	    </where>
	</select>
	
	<select id="findReturnAsset">
		WITH LatestRentData AS (
		    SELECT 
		        RC.asset_id,
		        R.return_date,
		        ROW_NUMBER() OVER(PARTITION BY RC.asset_id ORDER BY R.rent_date DESC) as RN
		    FROM Rent R
		    JOIN Rent_Content RC ON R.id = RC.rent_id
		),
		LatestHistoryData AS (
		    SELECT 
		        AH.asset_id,
		        AH.create_date,
		        ROW_NUMBER() OVER(PARTITION BY AH.asset_id ORDER BY AH.create_date DESC) as RN
		    FROM Asset_History AH
		)
		SELECT 
		    U.username,
		    U.email,
		    U.phone,
		    U.position,
		    D.dept_name,
		    D.dept_address,
		    A.asset_name,
		    A.serial_number,
		    A.spec,
		    A.location,
		    A.register_date,
		    C.category_name,
		    AR.id,
		    AR.asset_id,
		    AR.is_return,
		    AR.user_id,
		    LR.return_date,  
		    LH.create_date,  
		    TRUNC(LR.return_date) - TRUNC(SYSDATE) as deadLine
		FROM 
		    Asset_Return AR
		JOIN "User" U ON U.id = AR.user_id
		JOIN Department D ON D.id = U.department_id
		JOIN Asset A ON A.id = AR.asset_id
		JOIN Category C ON C.id = A.category_id
		LEFT OUTER JOIN LatestRentData LR ON LR.asset_id = A.id AND LR.RN = 1
		LEFT OUTER JOIN LatestHistoryData LH ON LH.asset_id = A.id AND LH.RN = 1
		WHERE 
		    AR.id = #{id}
	</select>
	
	<update id="updateAssetReturn">
		UPDATE Asset_Return 
		SET approver_id = #{approverId}
			,return_date = #{returnDate}
			,is_return = 1
		WHERE id = #{id}
	</update>
	
	<update id="updateAsset">
		UPDATE Asset
		SET user_id = null
			,location = '서울특별시 구로구 디지털로26길 123, 1605호 코오롱디지털타워'
			,is_request = 0
		WHERE id = #{assetId}	
	</update>

	<select id="getRentTop3">
		SELECT *
		FROM Rent r
			INNER JOIN Approval a ON r.approval_id = a.id
		WHERE r.user_id = #{userId}
		ORDER BY r.rent_date DESC
		FETCH FIRST 3 ROWS ONLY
	</select>
	
	<select id="getRentByApprovalId">
		SELECT *
		FROM Rent
		WHERE approval_id = #{approvalId}
	</select>
	
	<update id="cancelApproval">
		UPDATE Approval
		SET status = 'CANCEL'
		WHERE id IN (SELECT approval_id FROM Rent  WHERE id = #{id})
	</update>

</mapper>
