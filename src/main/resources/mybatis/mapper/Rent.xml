<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="edu.example.assetmanager.dao.RentDAO">
	<select id="findByAdminUser" resultType="UserInfoDTO">
		SELECT U.id
			   ,U.username
			   ,U.profile_image
			   ,D.dept_name
			   ,U.role
			   ,U.position
		FROM "User" U 
		JOIN Department D ON U.department_id = D.id
		WHERE D.dept_name = '경영지원팀' 
		AND U.role = 'admin'
	</select>
	
	<select id="findByManagerUser" resultType="UserInfoDTO">
		SELECT U.id
			   ,U.username
			   ,U.profile_image
			   ,D.dept_name
			   ,U.role
			   ,U.position
		FROM "User" U
		JOIN Department D ON U.department_id = D.id
		WHERE U.role = 'manager'
	</select>
	
	<select id="findByAsset" parameterType="int" resultType="AssetDTO">
		SELECT asset_name, spec, count(*) AS count
		FROM Asset		
		<where>
        <if test="categoryId != 0">
            AND category_id = #{categoryId}
        </if>
        	AND is_valid = 1
        	AND user_id IS NULL
        </where>
        GROUP BY asset_name, spec
	</select>
		
	<insert id="insertRent" parameterType="RentDTO" useGeneratedKeys="true" keyProperty="rentDTO.id" keyColumn="id">
		INSERT INTO Rent (approval_id, user_id, title, return_date, request_msg) 
		VALUES (#{rentDTO.approvalId}, #{userId}, #{rentDTO.title}, TO_TIMESTAMP(#{rentDTO.returnDate}, 'YYYY-MM-DD'), #{rentDTO.requestMsg})
	</insert>
	
	<insert id="insertRentContent" parameterType="RentContentDTO">
		INSERT INTO RENT_CONTENT (rent_id,asset_id)
		VALUES (#{rentContentDTO.rentId}, #{rentContentDTO.assetId})
	</insert>
	
	<select id="selectCount">
		SELECT id AS asset_id
		FROM Asset
		WHERE asset_name = #{assetName} 
			AND user_id IS NULL
			AND is_valid = 1
		FETCH FIRST #{count} ROWS ONLY			
	</select>
	
	<select id="findRentListByUserId" parameterType="int" resultType="RentListDTO">
	    SELECT
	        R.id,
	        R.title,
	        R.rent_date AS rentDate,
	        R.return_date AS returnDate,
	        A.status status
	    FROM 
	        Rent R
	    JOIN 
	        Approval A ON R.approval_id = A.id
	    WHERE 
	        R.user_id = #{userId}
	    AND R.is_valid = 1
	    ORDER BY 
	        R.rent_date DESC
	</select>
	
	<select id="getRentApprovalId" resultType="RentDTO">
		SELECT id
			   ,approval_id 
			   ,user_id
		FROM Rent R 
		WHERE R.id = #{id}
	</select>
	
	<select id="getRent">
		SELECT request_msg
			  ,return_date
			  ,rent_date
		FROM Rent R
		WHERE R.id = #{id}
	</select>
	
	<select id="getRentContent" >
		SELECT rent_id
			  ,user_id
			  ,asset_id
			  ,asset_name
			  ,category_name
			  ,spec
		FROM RENT_CONTENT RC
		JOIN Asset A ON RC.asset_id = A.id
		JOIN Category C ON C.id = A.category_id
		WHERE RC.rent_id = #{rentId}
	</select>
	
	<select id="findAdminListByUserId" resultType="RentListDTO">
	    SELECT R.id
	         , R.title
	         , R.rent_date rentDate
	         , A.status status
	         , U.username username
	         , D.dept_name deptName
	         , R.user_id
	    FROM Rent R
	    JOIN Approval A ON A.id = R.approval_id
	    LEFT JOIN "User" U ON U.id = R.user_id
	    LEFT JOIN Department D ON D.id = U.department_id
	    <where>
	        (A.approver_id = #{userId} OR A.manager_id = #{userId})
	        
	        <if test="status != null and status != ''">
	            <choose>
	                <when test="status == 'REJECT'">
	                    AND (UPPER(A.status) = 'FIRST_REJECT' OR UPPER(A.status) = 'FINAL_REJECT')
	                </when>
	                
	                <otherwise>
	                    AND UPPER(A.status) = #{status}
	                </otherwise>
	            </choose>
	        </if>
	    </where>
	    ORDER BY R.rent_date DESC
	</select>
	
	<select id="getDeptAddressByUserId" resultType="String">
        SELECT D.dept_address
        FROM "User" U
        JOIN Department D ON U.department_id = D.id
        WHERE U.id = #{userId}
    </select>
    
    <update id="cancelRent">
    	update Rent
    	set is_valid = 0
    	where id = #{id} 
    </update>
    
    <select id="getRentIdWithUserId">
    	SELECT *
    	FROM Rent 
    	WHERE user_id = #{userId} AND id = #{id}
    </select>
    
    <select id="getPendingRent">
		SELECT COUNT(r.id)
		FROM Rent r
			JOIN Approval a ON r.approval_id = a.id
		WHERE a.status = 'pending'
		AND r.user_id = #{userId}
		AND r.is_valid = 1
	</select>
	
	<select id="getApprovalRent">
		SELECT COUNT(r.id)
		FROM Rent r
			JOIN Approval a ON r.approval_id = a.id
		WHERE a.status = 'FINAL_APPROVAL'
		AND r.user_id = #{userId}
		AND r.is_valid = 1
	</select>
	
	<insert id="insertAssetReturn">
		INSERT INTO Asset_Return (user_id, asset_id,is_return)
		VALUES (#{userId}, #{assetId}, 0)
	</insert>
	
	<select id="findAssetReturn">
		SELECT AR.*
		      ,U.username
		      ,D.dept_name
		      ,A.*
		FROM Asset_Return AR
		JOIN "User" U ON U.id = AR.user_id
		JOIN Department D ON D.id = U.department_id
		JOIN Asset A ON A.id = AR.asset_id
		WHERE U.id = AR.user_id
	</select>
	
	<select id="findReturnAsset">
		SELECT U.username
			  ,U.email
			  ,U.phone
			  ,U.position
			  ,D.dept_name
			  ,D.dept_address
			  ,A.asset_name
			  ,A.serial_number
			  ,A.spec
			  ,A.location
			  ,A.register_date
			  ,C.category_name
			  ,AR.id
			  ,AR.asset_id
			  ,AR.is_return
			  ,AR.user_id
			  ,R.return_date  
			  ,AH.create_date
			  ,TRUNC(R.return_date) - TRUNC(SYSDATE) as deadLine
		FROM Asset_Return AR
        JOIN "User" U ON U.id = AR.user_id
        JOIN Department D ON D.id = U.department_id
        JOIN Asset A ON A.id = AR.asset_id
        JOIN Category C ON C.id = A.category_id
        LEFT OUTER JOIN Rent_Content RC ON RC.asset_id = A.id
        LEFT OUTER JOIN Rent R ON R.id = RC.rent_id
        JOIN Asset_History AH ON AH.asset_id = A.id  
        WHERE AR.id = #{id}
	</select>
	
	<update id="updateAssetReturn">
		UPDATE Asset_Return 
		SET approver_id = #{approverId}
			,return_date = #{returnDate}
			,is_return = 1
		WHERE id = #{id}
	</update>
	
	<update id="updateAsset">
		UPDATE Asset
		SET user_id = null
			,location = '서울특별시 구로구 디지털로26길 123, 1605호 (구로동, G+코오롱디지털타워)'
		WHERE id = #{assetId}	
	</update>

	<select id="getRentTop3">
		SELECT *
		FROM Rent r
			INNER JOIN Approval a ON r.approval_id = a.id
		WHERE r.user_id = #{userId}
		ORDER BY r.rent_date DESC
		FETCH FIRST 3 ROWS ONLY
	</select>

</mapper>
